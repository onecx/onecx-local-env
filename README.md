# OneCX Local Environment Setup

This repository contains the source code for the OneCX local development environment. 

`onecx-local-env` uses Docker and Docker Compose to enable developers to quickly run local instances of the OneCX Shell, selected OneCX products and their dependencies for development and testing purposes.

## Prerequisites

### Docker & Docker Compose
`onecx-local-env` requires both Docker and Docker Compose to be installed on your machine. The functionality of `onecx-local-env` has been tested with the following versions:

- Docker version `28.1.1`
- Docker Compose version `v2.35.1`

To ensure that all used features work correctly, please make sure to, at least, use Docker Compose version `v2.20.0`. If you are running into issues that aren't obviously related to your `onecx-local-env` itself, please try to update Docker and Docker Compose to the latest versions.

### Select which version of OneCX Local Env to use
This repository contains multiple versions of `onecx-local-env` inside the `versions` directory. Instructions for running services, importing initial data and other relevant information may differ between versions. It is therefore important to select a specific version of `onecx-local-env` before following the any other instructions in this document.

The current latest version of `onecx-local-env` is v2. We recommend this version for most users. Other versions, namely v1, still exist to avoid breaking existing workflows, but may not receive new features in the future. **If you are unsure which version to use, please start with v2.**

For more information on the versions please refer to the version-specific README files:
- [OneCX Local Env v2](./versions/v2/README.md)
- [OneCX Local Env v1](./versions/v1/README.md)

### Make all relevant scripts executable
After you selected a version of `onecx-local-env`, please ensure that all .sh scripts in the root directory of the repository, the `imports` directory and the `versions/<selected-version>` directory are executable.
- e.g. `-rwxr-xr-x import-onecx.sh`

If any of the scripts are not executable, please run the following command for each non-executable script:
 `chmod +x <file name>`

### Configure Hosts file

In order to expose multiple services on the same port, we use traefik reverse proxy. It will be available via your hosts 80 port, and will route traffic to container based on hostnames.
Therefore, for each service you want to access, add an entry to your *hosts* file in Windows: `c:\Windows\System32\drivers\etc\hosts` and Linux / WSL: `/etc/hosts`(wsl hosts file will be autogenerated from windows file when you restart wsl, unless you disabled that behaviour). Sample file (hosts.sample) is in this repo.

```
127.0.0.1   local-proxy
127.0.0.1   keycloak-app
127.0.0.1   pgadmin
127.0.0.1   onecx-shell-bff
127.0.0.1   onecx-theme-svc
127.0.0.1   onecx-theme-bff
127.0.0.1   onecx-workspace-svc
127.0.0.1   onecx-workspace-bff
127.0.0.1   onecx-user-profile-bff
127.0.0.1   onecx-user-profile-svc
127.0.0.1   onecx-permission-svc
127.0.0.1   onecx-permission-bff
127.0.0.1   onecx-product-store-svc
127.0.0.1   onecx-product-store-bff
127.0.0.1   onecx-iam-kc-svc
127.0.0.1   onecx-iam-bff
127.0.0.1   onecx-tenant-svc
127.0.0.1   onecx-tenant-bff
127.0.0.1   onecx-parameter-svc
127.0.0.1   onecx-parameter-bff
```

### Import Initial Data

Before using the selected version of `onecx-local-env`, initial data must be imported to set up the environment correctly. Please refer to the version-specific README files for instructions on how to import the initial data:
- [Importing initial data for OneCX Local Env v2](./versions/v2/README.md#importing-initial-data)
- [Importing initial data for OneCX Local Env v1](./versions/v1/README.md#importing-initial-data)

The respective import scripts will import all data located in the `./imports` directory. The structure of the `imports` directory is as follows:

* tenant - import for the tenants
* theme - import for the themes
* permissions - import for permissions
* workspace - import for workspaces
* assignments - import of the assignments from role to permission
* product-store - import for all of the product/application store objects:
  * products - import for products/applications
  * microfrontends - import for microfrontends
  * microservices - import for microservices
  * slots - import for slots

## Running OneCX Local Env
For instructions on how to run your selected version of `onecx-local-env`, please refer to the version-specific README files:
- [Running OneCX Local Env v2](./versions/v2/README.md#running-onecx-local-env-v2)
- [Running OneCX Local Env v1](./versions/v1/README.md#running-onecx-local-env-v1)

After running all desired services as per the version-specific instructions, you can access the OneCX Shell via this URL: `http://local-proxy/onecx-shell/admin`. The default user created by the previously-executed import scripts is `onecx` with the password `onecx`.

If there are any issues while running services, please try to:
* deleting the volume or 
* clearing the database and
* starting everything again from scratch

## Default Databases

Postgres server is automatically created with the necessary databases.
If any database needs to be added please modify the file `init-data/db/init-db.sql`

Keycloak db is populated with the following configuration(located in `init-data/keycloak/realm-onecx.json`):

- **Realm** - onecx
- **Clients** - all necessary UI clients for MFE and backends are in the
- **User** - onecx
- **Password** - onecx
- **Roles assigned to the user** - [onecx-admin]

## Adding and running new microfrontend (MFE)

In order to run the MFE all corresponding BFFs and all corresponding backend services (MS) need to run also.

### Localy build docker image of the MFE

After a local docker image of the MFE is created, add it to the docker-compose and started as any other service.

### Localy started in dev mode `npm start`

In order to use traefik and locally started MFE you need to enhance the npm start script located in package.json with `--host 0.0.0.0 --disable-host-check`

If it runs on the standard port *4200* you dont need to do anything special as this is already configured for the local_mfe service under `./init-data/traefik/traefik-services.yml`
Only update the traefik config in `docker-compose.yaml`

*EXAMPLE* for onecx-tenant-ui (its already part of the docker-compose in the part of onecx-tenant-bff)
```
	  - "traefik.http.routers.local_mfe.entrypoints=web"
      - "traefik.http.routers.local_mfe.rule=Host(`local-proxy`)&&PathPrefix(`/mfe/tenant/`)"
      - "traefik.http.routers.local_mfe.service=local_mfe@file"
```

In order to get this working also the local proxy configuration of the MFE needs to be updated like this:
```
const PROXY_CONFIG = {
  '/mfe/tenant': {
    target: 'http://localhost:4200/',
    secure: false,
    pathRewrite: {
      '^.*/mfe/tenant': '',
    },
    changeOrigin: true,
    logLevel: 'debug',
    bypass: bypassFn,
  }
```
