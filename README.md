# OneCX Local Environment Setup

Setup the local OneCX environment using *docker compose*

## Preparation

Make sure that all `.sh` scripts in root and /imports directory (and its subdirectories) are executable.
- e.g. `-rwxr-xr-x import-onecx.sh`
If they are not executable then use the command `chmod +x <file name>`

## Docker Compose

The docker compose configuration contains settings for the following services:

- `postgresdb` generic postgresql db
- `pgadmin` UI admin for Postgres, login as user@example.com/mysecretpassword
- `traefik` reverse proxy
- `keycloak-app` Access and Identity Management Tool
- OneCX portal products with its MS
  - `onecx-shell`
  - `onecx-permission`
  - `onecx-theme`
  - `onecx-iam`
  - `onecx-product-store`
  - `onecx-tenant`
  - `onecx-user-profile`
  - `onecx-workspace`

To run all the services (don't do it unless you really have to, always start only those services you need):

- `docker-compose up -d` (in case you are using Compose V1 - separated from docker)
- `docker compose up -d` (in case you are using Compose V2 - integrated within docker)

## Hosts file

In order to expose multiple services on the same port, we use traefik reverse proxy. It will be available via your hosts 80 port, and will route traffic to container based on hostnames.
Therefore, for each service you want to access, add an entry to your *hosts* file in Windows: `c:\Windows\System32\drivers\etc\hosts` and Linux / WSL: `/etc/hosts`(wsl hosts file will be autogenerated from windows file when you restart wsl, unless you disabled that behaviour). Sample file (hosts.sample) is in this repo.

```
127.0.0.1   local-proxy
127.0.0.1   keycloak-app
127.0.0.1   pgadmin
127.0.0.1   onecx-shell-bff
127.0.0.1   onecx-theme-svc
127.0.0.1   onecx-theme-bff
127.0.0.1   onecx-workspace-svc
127.0.0.1   onecx-workspace-bff
127.0.0.1   onecx-user-profile-bff
127.0.0.1   onecx-user-profile-svc
127.0.0.1   onecx-permission-svc
127.0.0.1   onecx-permission-bff
127.0.0.1   onecx-product-store-svc
127.0.0.1   onecx-product-store-bff
127.0.0.1   onecx-iam-kc-svc
127.0.0.1   onecx-iam-bff
127.0.0.1   onecx-tenant-svc
127.0.0.1   onecx-tenant-bff
```

## Databases

Postgres server is automatically created with the necessary databases.
If any database needs to be added please modify the file `init-data/db/init-db.sql`

Keycloak db is populated with the following configuration(located in `init-data/keycloak/realm-onecx.json`):

- **Realm** - onecx
- **Clients** - all necessary UI clients for MFE and backends are in the
- **User** - onecx
- **Password** - onecx
- **Roles assigned to the user** - [onecx-admin]

## Import Initial Data

In order to import the inital data use the script `./import-onecx.sh`. Before the script is executed all the core backend services of OneCX have to be up and running.

Folder structure in `./imports/`:
* tenant - import for the tenants
* theme - import for the themes
* permissions - import for permissions
* workspace - import for workspaces
* assignments - import of the assignments from role to permission
* product-store - import for all of the product/application store objects:
  * products - import for products/applications
  * microfrontends - import for microfrontends
  * microservices - import for microservices
  * slots - import for slots

## Running

When running with the command `docker-compose up -d` all services (see list above) are started and the core portal can be accessed via this url `http://local-proxy/onecx-shell/admin`

After all services of OneCX are up and running start the script `./import-onecx.sh`.
This will import all initially necessary data to the database.
There is a user created from scratch (onecx with password onecx).

If there are some issues to run OneCX microservices or the users are missing then
* deleting the volume or 
* clearing the database and
* starting everything again from scratch

## Adding new microfrontend (MFE)

In order to run the MFE all corresponding BFFs and all corresponding backend services (MS) need to run also.

### Localy build docker image of the MFE

After a local docker image of the MFE is created, add it to the docker-compose and started as any other service.

### Localy started in dev mode `npm start`

In order to use traefik and locally started MFE you need to enhance the npm start script located in package.json with `--host 0.0.0.0 --disable-host-check`

If it runs on the standard port *4200* you dont need to do anything special as this is already configured for the local_mfe service under `./init-data/traefik/traefik-services.yml`
Only update the traefik config in `docker-compose.yaml`

*EXAMPLE* for onecx-tenant-ui (its already part of the docker-compose in the part of onecx-tenant-bff)
```
	  - "traefik.http.routers.local_mfe.entrypoints=web"
      - "traefik.http.routers.local_mfe.rule=Host(`local-proxy`)&&PathPrefix(`/mfe/tenant/`)"
      - "traefik.http.routers.local_mfe.service=local_mfe@file"
```

In order to get this working also the local proxy configuration of the MFE needs to be updated like this:
```
const PROXY_CONFIG = {
  '/mfe/tenant': {
    target: 'http://localhost:4200/',
    secure: false,
    pathRewrite: {
      '^.*/mfe/tenant': '',
    },
    changeOrigin: true,
    logLevel: 'debug',
    bypass: bypassFn,
  }
```
