
= Adding Custom Certificates for Java Applications in Docker

== Why You Might Need Custom Certificates

When running Java applications inside Docker containers, HTTPS connections often fail with errors like:

[source,text]
----
PKIX path building failed: unable to find valid certification path to requested target
----

=== Common Use Cases

* **Corporate TLS Interception**: Tools like Zscaler or internal proxies re-sign certificates with a corporate CA.
* **Self-Signed Certificates**: Internal services using self-signed certs.
* **Private PKI**: Enterprise environments with custom root or intermediate CAs.

=== Problems If Not Fixed

* Outbound HTTPS calls fail (e.g., REST APIs, OAuth, external services).
* Java throws any TLS/SSL exception e.g.  `SunCertPathBuilderException`.

== How to Add Custom Certificates

=== Step 1: Export the Certificate

You need the **root CA** (and sometimes intermediate CA) that signs the server certificate.

==== Option A: From Browser

. Open the HTTPS site in Chrome/Edge/Firefox
. Click the padlock icon → *Certificate* → *Details*
. Export the **root** and **intermediate** certificates as Base-64 encoded `.crt` files

==== Option B: From Windows Certificate Manager

. Run `certmgr.msc`
. Navigate to:
  ** *Trusted Root Certification Authorities* → export the root CA
  ** *Intermediate Certification Authorities* → export the issuing CA
. Save as `.crt` files (Base-64 encoded)

==== Placement

Place the exported files in the certs folder inside of onecx-local-env:

[source]
----
certs/
├── YourCertificate.crt
└── YourCertificate2.crt
----

=== Step 2: Create a Java Truststore

Use the provided setup script to create or update a truststore with all your certificates.

The script automatically imports all `.crt` and `.pem` files from the specified directory.

[source,bash]
----
./setup-truststore.sh
----

This generates:

[source]
----
certs/truststore.jks
----

==== Verify the Truststore Contents

To list all imported certificates, step inside the certs directory and run:

[source,bash]
----
keytool -list -keystore truststore.jks -storepass changeit
----

Expected output showing all imported certificates with their aliases.

=== Step 3: Mount Truststore in Docker Compose

Update your `docker-compose.yml` to mount the truststore and configure Java to use it.

[source,yaml]
----
services:
  onecx-ai-svc:
    image: ${ONECX_AI_SVC}
    volumes:
      - ./certs/truststore.jks:/opt/certs/truststore.jks:ro
    environment:
      JAVA_TOOL_OPTIONS: >-
        -Djavax.net.ssl.trustStore=/opt/certs/truststore.jks
        -Djavax.net.ssl.trustStorePassword=changeit
        -Djavax.net.ssl.trustStoreType=JKS
----

=== Step 4: Restart and Verify

. Verify the SSL/TLS connection works by triggering an HTTPS call and confirming no `PKIX path building failed` or any other TLS/SSL error appears.