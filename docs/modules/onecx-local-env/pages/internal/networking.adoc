ifdef::env-site[]
include::partial$_attributes.adoc[]
endif::[]
:imagesdir: ../../images

= Networking in OneCX Local Environment

:different_ports: xref:documentation:onecx-docs-start/enable_hot_reload.adoc#note-different-ports
:ole_setup: xref:onecx-local-env:setup.adoc

This document explains how networking is configured and managed in the OneCX Local Environment.

[#docker-resource-names]
== Docker Resource Names
To isolate the local OneCX environment from the host system and other Docker environments, Docker uses the project name *onecx-local-env*. This project name serves as a prefix for all created Docker resources (containers, networks, volumes), ensuring seamless communication between all services while minimizing disruptions and conflicts.

The following Docker resource names and prefixes are used in the OneCX Local Environment:

[horizontal]
Project Name::      `onecx-local-env`
Network Name::      `onecx-local-env_onecx`
Container Prefix::  `onecx-local-env_`


== Network Actors and Components
The OneCX Local Environment uses a sophisticated networking setup that combines:

* Traefik
* Service Discovery and Routing
* Docker Compose Network
* Host file Configuration
* Environment Configuration

=== Traefik

Traefik serves as the central entry point for all HTTP traffic in the OneCX environment. It acts as:

[horizontal,labelwidth=20]
Reverse Proxy::        Routes incoming requests to appropriate backend services
Load Balancer::        Distributes traffic across service instances
Service Discovery::    Automatically detects new services through Docker labels
API Gateway::          Provides a single entry point for all microservices

Configuration::        The Traefik configuration is split across multiple files: +
* `init-data/traefik/base/traefik-conf.yml` +
  Main configuration
* `init-data/traefik/base/traefik-services.yml` +
  Static service definitions for local development
* `versions/<version>/compose.yaml` +
  OneCX service registrations

Traefik Settings::     `traefik-conf.yml`
[source,yaml]
----
entryPoints:
  web:
    address: ":80"  # HTTP entry point
providers:
  docker:
    endpoint: unix:///var/run/docker.sock
  file:
    directory: /etc/traefik/active
    watch: true
----

Pls. aware the locations of Traefik configuration files are mapped as follows:
----
init-data/traefik/base/traefik-conf.yml  => /etc/traefik/traefik.yml
init-data/traefik/active                 => /etc/traefik/active
----

=== Service Discovery

Traefik Labels::

Services register themselves with Traefik using Docker labels:

.Traefik Label Patterns: SVC and BFF
[source,yaml]
----
labels:
  - "traefik.http.services.<service-name>.loadbalancer.server.port=8080"
  - "traefik.http.routers.<service-name>.rule=Host(`<service-name>`)"
----

.Traefik Label Patterns: UI
[source,yaml]
----
labels:
  - "traefik.http.services.<ui-service-name>.loadbalancer.server.port=8080"
  - "traefik.http.routers.<ui-service-name>.rule=Host(`local-proxy`) && PathPrefix(`/<app-path>/`)"
----


=== Service Routing Rules

Different routing patterns are used for different service types:

.Backend Services (BFF/SVC) and Infrastructure Services
[source,yaml]
----
Host(`service-name`)
----

.Frontend Applications (UI)
[source,yaml]
----
Host(`local-proxy`) && PathPrefix(`/app-path/`)
----

=== Port Mapping Strategy

External Ports (Host → Container)::
Key external ports exposed to the host:
+
[cols="2,2,3"]
|===
| Service | Host Port | Purpose

| Traefik HTTP
| 80
| Main HTTP entry point

| Traefik Dashboard
| 8082
| Web UI for Traefik management

| Keycloak
| 8080
| Identity and access management

| PostgreSQL
| 5432
| Database direct access
|===

//
Internal Ports (Container → Container):: Services communicate internally using standard ports: +

[horizontal,indentSize=4]
Web Services::          Port 8080 (Quarkus default)
PostgreSQL::            Port 5432
Frontend Applications:: Port 8080 (Nginx)


=== Docker Compose Network
Here only the v2 edition is described. The v1 edition is similar but uses the `example` network.

Central configuration of the Docker Compose network is defined in `versions/v2/compose.yaml`

.Network Configuration in Docker Compose
image::onecx-network-in-docker-compose.png[width=300]

The network alias used by the services is *onecx*. On project level the network is named *onecx-local-env_onecx*. This is also the name visible when executing `docker network ls`. See section at the top of this document about the xref:#docker-resource-names[Docker resource names].


Network Features::
[horizontal]
Service-to-Service Communication:: Services can communicate using container names as hostnames
Automatic DNS Resolution::         Docker provides built-in DNS for container name resolution
Network Isolation::                Traffic is isolated from the host network and other Docker networks
Network Communication Patterns::   Services communicate using these patterns

[cols="2,3,3"]
|===
| Communication Type | Example | URL Pattern

| Frontend to BFF
| Shell UI → Shell BFF
| `http://onecx-shell-bff:8080`

| BFF to Service  
| Shell BFF → Theme Service
| `http://onecx-theme-svc:8080`

| Service to Database
| Theme Service → PostgreSQL
| `jdbc:postgresql://postgresdb:5432/onecx_theme`

| Service to Keycloak
| Any Service → Keycloak
| `http://keycloak-app:8080`
|===


=== Host File Configuration
Check the {ole_setup}#hosts[hosts entries section] for detailed instructions.


=== Environment Configuration

Within the Docker Compose files (`compose.yaml`), several environment variables are used to manage settings for services:

The source of the environment variables is located in the version folder: `versions/v2/.env`. +
Here the link:https://raw.githubusercontent.com/onecx/onecx-local-env/refs/heads/main/versions/v2/.env[Link to GitHub source file].

.Environment variables used in Docker Compose
[%collapsible]
====
link:https://raw.githubusercontent.com/onecx/onecx-local-env/refs/heads/main/versions/v2/.env[Link to GitHub source file]

include::./_onecx-env.adoc[]
====

.Environment variable sets defined in Docker Compose
[%collapsible]
====
link:https://raw.githubusercontent.com/onecx/onecx-local-env/refs/heads/main/versions/v2/docker-compose.yaml[Link to GitHub source file]

include::./_onecx-env-sets.adoc[]
====

.Environment variable set use for BFF services
[%collapsible]
====
[source,yaml]
----
  onecx-announcement-bff:
    ...
    environment:
      <<: *bff_environment
      ...
----
====

.Environment variable set use for services with `multi-tenancy` awareness
[%collapsible]
====
[source,yaml]
----
  onecx-announcement-svc:
    ...
    environment:
      <<: *svc_multi_tenancy
      ...
----
====

.Environment variable set use for services with `single-tenancy` awareness
[%collapsible]
====
[source,yaml]
----
  onecx-iam-svc:
    ...
    environment:
      <<: *svc_single_tenancy
      ...
----
====


== Access Patterns
The following access patterns illustrate how different components of the OneCX Local Environment can be accessed.

OneCX Shell::    Main Entry Point
Shell UI::
  `http://local-proxy/onecx-shell/admin` +
  All OneCX application UIs are accessed through the Shell workspace navigation
Workspace Management UI via Shell::
  `http://local-proxy/onecx-shell/admin/workspace`
Workspace Microfrontend::
  `http://local-proxy/mfe/workspace/`
Workspace BFF::
  `http://local-proxy/mfe/workspace/bff/`
Workspace Service::
  `http://onecx-workspace-svc:8080/`
Traefik Routing Rule::  
  `traefik.http.routers.onecx-workspace-ui.rule=Host(local-proxy) && PathPrefix(/mfe/*workspace*/)`

See also the collection of utility services documented in xref:../utilities.adoc[Utilities].


=== Microservice Communication
Services within the OneCX Local Environment communicate using standard internal URLs based on container names and ports.

[horizontal, labwidth=40]
Frontend calls BFF::       `http://local-proxy/mfe/<service-name>/bff/<bff-resource>`
BFF calls Service::        `http://<service-name>:8080/<svc-resource>`
Service access database::  `jdbc:postgresql://postgresdb:5432/db_name`
Service authenticate via:: `http://keycloak-app:8080`


== Development Support
The xref:../extend/extend.adoc[Extend OneCX] documentation describes how local running services are integrated into the OneCX Local Environment.


== Security Considerations

=== Network Isolation

* Services are isolated within the Docker network
* Only necessary ports are exposed to the host
* Database is not directly accessible from outside (only via port 5432)

=== Authentication Flow

1. Browser → Traefik (local-proxy) → Frontend
2. Frontend → Traefik → BFF Service
3. BFF → Keycloak (authentication)
4. BFF → Backend Services (with token)
